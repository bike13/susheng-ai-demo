pipeline {
    agent any

    parameters {
        string(name: 'git_branch', defaultValue: 'main', description: 'Git branch to build')
    }

    environment {
        DOCKER_IMAGE = 'susheng-ai-demo:pro'
        DOCKER_CONTAINER = 'susheng-ai-app'
        MYSQL_HOST = 'sql.freedb.tech'
        MYSQL_PORT = '3306'
        WORKSPACE_DIR = "${WORKSPACE}"
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "Building from branch: ${params.git_branch}"
                    
                    // Jenkinså·²ç»è‡ªåŠ¨æ£€å‡ºäº†ä»£ç ï¼Œæˆ‘ä»¬åªéœ€è¦éªŒè¯
                    sh '''
                        echo "=== éªŒè¯ä»£ç æ£€å‡º ==="
                        echo "å½“å‰ç›®å½•: $(pwd)"
                        echo "æ–‡ä»¶åˆ—è¡¨:"
                        ls -la
                        echo "Dockerfileæ£€æŸ¥:"
                        if [ -f "Dockerfile" ]; then
                            echo "âœ… Dockerfileå­˜åœ¨"
                            echo "å½“å‰åˆ†æ”¯: $(git branch --show-current 2>/dev/null || echo 'æ— æ³•è·å–åˆ†æ”¯')"
                        else
                            echo "âŒ Dockerfileä¸å­˜åœ¨"
                            exit 1
                        fi
                    '''
                }
            }
        }
        
        stage('Diagnose') {
            steps {
                script {
                    echo "=== è¯Šæ–­ä¿¡æ¯ ==="
                    sh 'echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"'
                    sh 'echo "Jenkinså·¥ä½œç©ºé—´: $WORKSPACE"'
                    sh 'echo "ç¯å¢ƒå˜é‡WORKSPACE_DIR: $WORKSPACE_DIR"'
                    sh 'echo "å½“å‰Gitåˆ†æ”¯: $(git branch --show-current 2>/dev/null || echo "æ— æ³•è·å–åˆ†æ”¯ä¿¡æ¯")"'
                    sh 'echo "Gitè¿œç¨‹åˆ†æ”¯åˆ—è¡¨:"'
                    sh 'git branch -r 2>/dev/null || echo "æ— æ³•è·å–è¿œç¨‹åˆ†æ”¯"'
                    sh 'ls -la'
                    sh 'echo "æŸ¥æ‰¾Dockerfile:"'
                    sh 'find . -name "Dockerfile" -type f -exec echo "æ‰¾åˆ°: {}" \\;'
                    sh 'test -f Dockerfile && echo "âœ… Dockerfileå­˜åœ¨" || echo "âŒ Dockerfileä¸å­˜åœ¨"'
                    sh 'echo "Dockerfileå†…å®¹é¢„è§ˆ:"'
                    sh 'head -5 Dockerfile 2>/dev/null || echo "æ— æ³•è¯»å–Dockerfile"'
                }
            }
        }
        
        stage('Build & Deploy') {
            steps {
                script {
                    // åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
                    sh 'docker stop $DOCKER_CONTAINER 2>/dev/null || true'
                    sh 'docker rm $DOCKER_CONTAINER 2>/dev/null || true'
                    
                    // æ„å»ºæ–°é•œåƒ
                    sh 'docker build --no-cache -t $DOCKER_IMAGE .'
                    
                    // å¯åŠ¨æ–°å®¹å™¨
                    sh 'docker run -d --name $DOCKER_CONTAINER -p 8000:8000 -e MYSQL_HOST=$MYSQL_HOST -e MYSQL_PORT=$MYSQL_PORT $DOCKER_IMAGE'
                }
            }
        }
    }

    post {
        success {
            echo 'âœ… éƒ¨ç½²æˆåŠŸ!'
            echo 'ğŸŒ åº”ç”¨åœ°å€: http://localhost:8000'
            echo 'ğŸ“š APIæ–‡æ¡£: http://localhost:8000/docs'
        }
        failure {
            echo 'âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—'
        }
    }
}
